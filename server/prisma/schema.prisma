// Prisma Schema for Yemen News Platform
// MySQL Database

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============= ENUMS =============

enum Role {
  ADMIN
  EDITOR
  JOURNALIST
  READER
}

enum ArticleStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RSSSourceStatus {
  ACTIVE
  PAUSED
  ERROR
}

enum RSSArticleStatus {
  PENDING      // Awaiting editorial review
  APPROVED     // Approved for display
  REJECTED     // Rejected by editor
  EXPIRED      // Auto-archived after X days
}

// ============= MODELS =============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(READER)
  avatar    String?
  bio       String?  @db.Text
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  articles   Article[]
  comments   Comment[]
  activities ActivityLog[]

  @@index([email])
  @@index([role])
}

model Article {
  id          String        @id @default(uuid())
  title       String        @db.VarChar(255)
  slug        String        @unique @db.VarChar(255)
  excerpt     String        @db.Text
  content     String        @db.LongText
  imageUrl    String?       @db.VarChar(500)
  status      ArticleStatus @default(DRAFT)
  views       Int           @default(0)
  readTime    Int           @default(5)
  seoTitle    String?       @db.VarChar(255)
  seoDesc     String?       @db.Text
  isBreaking  Boolean       @default(false)
  isFeatured  Boolean       @default(false)
  publishedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  authorId   String
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  
  tags     ArticleTag[]
  comments Comment[]

  @@index([slug])
  @@index([status, publishedAt])
  @@index([categoryId])
  @@index([authorId])
  @@index([isBreaking])
  @@fulltext([title, excerpt, content])
}

model Category {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  color       String  @default("#2563EB") @db.VarChar(20)
  icon        String? @db.VarChar(50)
  description String? @db.Text
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  articles   Article[]
  rssSources RSSSource[]

  @@index([slug])
  @@index([isActive, sortOrder])
}

model Tag {
  id   String @id @default(uuid())
  name String @unique @db.VarChar(50)
  slug String @unique @db.VarChar(50)

  articles ArticleTag[]

  @@index([slug])
}

model ArticleTag {
  articleId String
  tagId     String

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
}

model Comment {
  id        String        @id @default(uuid())
  content   String        @db.Text
  status    CommentStatus @default(PENDING)
  likes     Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  authorId  String
  author    User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies   Comment[] @relation("CommentReplies")

  @@index([articleId, status])
  @@index([authorId])
}

model Media {
  id         String   @id @default(uuid())
  filename   String   @db.VarChar(255)
  url        String   @db.VarChar(500)
  type       String   @db.VarChar(50)
  size       Int
  alt        String?  @db.VarChar(255)
  uploaderId String
  createdAt  DateTime @default(now())

  @@index([type])
  @@index([uploaderId])
}

model ActivityLog {
  id          String   @id @default(uuid())
  action      String   @db.VarChar(50)
  targetType  String   @db.VarChar(50)
  targetId    String   @db.VarChar(100)
  targetTitle String   @db.VarChar(255)
  details     String?  @db.Text
  ipAddress   String?  @db.VarChar(45)
  userAgent   String?  @db.VarChar(255)
  createdAt   DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
  @@index([targetType, targetId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============= RSS FEED MODELS =============

model RSSSource {
  id             String          @id @default(uuid())
  name           String          @db.VarChar(100)        // e.g., "الجزيرة نت"
  feedUrl        String          @unique @db.VarChar(500)
  websiteUrl     String?         @db.VarChar(500)        // Source homepage
  logoUrl        String?         @db.VarChar(500)        // Source logo for attribution
  description    String?         @db.Text
  
  status         RSSSourceStatus @default(ACTIVE)
  fetchInterval  Int             @default(15)             // Minutes between fetches
  lastFetchedAt  DateTime?
  lastError      String?         @db.Text
  errorCount     Int             @default(0)
  
  autoApprove    Boolean         @default(false)          // Skip moderation queue
  isActive       Boolean         @default(true)
  
  categoryId     String                                   // Map to platform category
  category       Category        @relation(fields: [categoryId], references: [id])
  
  articles       RSSArticle[]
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([status])
  @@index([categoryId])
  @@index([lastFetchedAt])
}

model RSSArticle {
  id             String           @id @default(uuid())
  guid           String           @unique @db.VarChar(500)  // Unique identifier from feed
  
  title          String           @db.VarChar(500)
  excerpt        String?          @db.Text                  // 200 chars max, from feed
  sourceUrl      String           @db.VarChar(500)          // Link to original article
  imageUrl       String?          @db.VarChar(500)
  
  status         RSSArticleStatus @default(PENDING)
  
  publishedAt    DateTime                                   // From feed pubDate
  fetchedAt      DateTime         @default(now())
  approvedAt     DateTime?
  approvedById   String?
  
  sourceId       String
  source         RSSSource        @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  // Duplicate detection helpers
  titleHash      String?          @db.VarChar(64)           // SHA-256 of normalized title
  
  // AI Rewriting fields
  rewrittenTitle    String?          @db.VarChar(500)
  rewrittenExcerpt  String?          @db.Text
  isRewritten       Boolean          @default(false)
  rewrittenAt       DateTime?
  
  @@index([status])
  @@index([sourceId])
  @@index([publishedAt])
  @@index([guid])
  @@index([titleHash])
}
